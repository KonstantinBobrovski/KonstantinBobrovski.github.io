<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Skopje ‚Äî Extended Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">

<style>
  body { margin:0; padding:0; font-family: Arial, sans-serif; }
  #map { height: 100vh; width: 100%; }
  .loc-button {
    position:absolute;
    top:10px;
    right:10px;
    padding:8px 10px;
    background:white;
    border:1px solid #aaa;
    cursor:pointer;
    z-index:1000;
  }
  .legend-note {
    position:absolute;
    left:10px;
    bottom:10px;
    background:rgba(255,255,255,0.9);
    padding:8px;
    border-radius:6px;
    font-size:13px;
    z-index:1000;
  }
</style>
</head>

<body>

<div id="map"></div>
<button class="loc-button" onclick="locateUser()">üìç My Location</button>
<div class="legend-note">Markers are grouped by category. Toggle layers top-right.</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
// MAP
var map = L.map('map');

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom:19,
  attribution:'¬© OpenStreetMap'
}).addTo(map);

// ICONS
function icon(color) {
  return L.icon({
    iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize:[25,41],
    iconAnchor:[12,41]
  });
}

var icons = {
  sightseeing: icon("red"),
  monuments: icon("orange"),
  museum: icon("violet"),
  gallery: icon("purple"),
  food: icon("green"),
  nature: icon("blue"),
  daytrip: icon("yellow"),
  activities: icon("grey")
};

// LAYERS (clustered)
var layers = {
  "üèõ Sightseeing": L.markerClusterGroup(),
  "üìú Monuments & Cultural Sites": L.markerClusterGroup(),
  "üñº Museums": L.markerClusterGroup(),
  "üñº Galleries": L.markerClusterGroup(),
  "üçΩ Food & Nightlife": L.markerClusterGroup(),
  "üåø Nature & Views": L.markerClusterGroup(),
  "üöó Day Trips": L.markerClusterGroup(),
  "üé≤ Activities & Entertainment": L.markerClusterGroup()
};

// CATEGORY MAP
var CATEGORY_MAP = {
  "Monuments & Cultural Sites": { layer:"üìú Monuments & Cultural Sites", icon:"monuments" },
  "Historic Buildings": { layer:"üìú Monuments & Cultural Sites", icon:"monuments" },
  "Architecture": { layer:"üìú Monuments & Cultural Sites", icon:"monuments" },
  "Religion": { layer:"üìú Monuments & Cultural Sites", icon:"monuments" },
  "Religion & Cultural Sites": { layer:"üìú Monuments & Cultural Sites", icon:"monuments" },

  "Museums": { layer:"üñº Museums", icon:"museum" },
  "Museums & Galleries": { layer:"üñº Museums", icon:"museum" },
  "Galleries": { layer:"üñº Galleries", icon:"gallery" },

  "Food & Nightlife": { layer:"üçΩ Food & Nightlife", icon:"food" },

  "Nature & Outdoors": { layer:"üåø Nature & Views", icon:"nature" },
  "Landmarks & Viewpoints": { layer:"üåø Nature & Views", icon:"nature" },

  "Day Trips": { layer:"üöó Day Trips", icon:"daytrip" },

  "Activities": { layer:"üé≤ Activities & Entertainment", icon:"activities" },
  "Family Activities": { layer:"üé≤ Activities & Entertainment", icon:"activities" }
};

// DATA
var places = [
  {
    name:"–°–æ–±–æ—Ä –°–≤—è—Ç–æ–≥–æ –ö–ª–∏–º–µ–Ω—Ç–∞ (Cathedral of St. Clement of Ohrid)",
    description:"Large modern Orthodox cathedral dedicated to St. Clement of Ohrid ‚Äî one of Skopje‚Äôs most important religious landmarks.",
    categories:["Religion"],
    location:{lat:41.9929, lon:21.4255},
    sources:["https://en.wikipedia.org/wiki/Cathedral_of_St._Clement_of_Ohrid"]
  },
  {
    name:"Skopje Fortress (Kale)",
    description:"Historic hilltop fortress with panoramic city views.",
    categories:["Monuments & Cultural Sites"],
    location:{lat:42.00097, lon:21.43225},
    sources:["https://en.wikipedia.org/wiki/Skopje_Fortress"]
  },
  {
    name:"Old Bazaar (Stara ƒåar≈°ija)",
    description:"Historic Ottoman bazaar district with shops, mosques and caf√©s.",
    categories:["Monuments & Cultural Sites"],
    location:{lat:42.00076, lon:21.43696},
    sources:["https://en.wikipedia.org/wiki/Old_Bazaar,_Skopje"]
  },
  {
    name:"Matka Canyon",
    description:"Dramatic canyon west of Skopje with hiking, boats and caves.",
    categories:["Nature & Outdoors","Day Trips"],
    location:{lat:41.93016, lon:21.29227},
    sources:["https://en.wikipedia.org/wiki/Matka_Canyon"]
  }
];

// POPUPS
function popupContent(p) {
  var links = (p.sources || []).map(s =>
    `<a href="${s}" target="_blank">source</a>`
  ).join(" ‚Ä¢ ");
  return `<b>${p.name}</b><br>${p.description}<br>${links}`;
}

// ADD MARKERS
var bounds = L.latLngBounds([]);

places.forEach(function(p) {
  var marker = L.marker([p.location.lat, p.location.lon], {
    icon: icons.sightseeing
  }).bindPopup(popupContent(p));

  bounds.extend([p.location.lat, p.location.lon]);

  p.categories.forEach(function(cat) {
    var cfg = CATEGORY_MAP[cat];
    if (!cfg) {
      console.warn("Unknown category:", cat, "in", p.name);
      return;
    }
    marker.setIcon(icons[cfg.icon] || icons.sightseeing);
    if (cfg.layer === "üöó Day Trips") marker.setZIndexOffset(-1000);
    layers[cfg.layer].addLayer(marker);
  });
});

// ADD LAYERS
Object.values(layers).forEach(l => map.addLayer(l));
L.control.layers(null, layers).addTo(map);

// FIT MAP
if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));

// PERSIST LAYERS
var saved = JSON.parse(localStorage.getItem("layers") || "[]");
if (saved.length) {
  Object.entries(layers).forEach(([k,l]) => {
    if (!saved.includes(k)) map.removeLayer(l);
  });
}

map.on("overlayadd overlayremove", function() {
  var active = Object.keys(layers).filter(k => map.hasLayer(layers[k]));
  localStorage.setItem("layers", JSON.stringify(active));
});

// GEOLOCATION
var userMarker;
function locateUser() {
  if (!navigator.geolocation) return alert("Geolocation not supported.");
  navigator.geolocation.getCurrentPosition(function(pos) {
    var lat = pos.coords.latitude, lon = pos.coords.longitude;
    if (userMarker) map.removeLayer(userMarker);
    userMarker = L.circleMarker([lat,lon], {
      radius:8, color:"#007bff", fillOpacity:0.8
    }).addTo(map).bindPopup("You are here").openPopup();
    map.setView([lat,lon],14);
  }, err => alert(err.message), {enableHighAccuracy:true});
}
</script>
</body>
</html>
